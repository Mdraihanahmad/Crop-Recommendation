<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Crop Recommendation</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    </head>
    <body>
        <nav>
            <div class="brand"><span>üå±</span> AI Crop Predict</div>
            <ul>
                <li><a href="https://ai-crop-recommendation-iota.vercel.app/" class="active">Home</a></li>
                <li><a href="#form">Predict</a></li>
                <li><a href="#about">About</a></li>
            </ul>
        </nav>
        <main class="main-wrap">
            <section class="hero">
                <h1><span>AI CROP RECOMMENDATION</span></h1>
                <p>Enter soil and climate parameters or let us auto-fill using your location to get a tailored crop recommendation powered by machine learning.</p>
                <div class="actions">
                    <a href="#form" class="btn">Go to Predictor ‚Üí</a>
                    <button class="btn outline" type="button" onclick="fetchLocationAndSoilData()">Auto Fill via Location</button>
                </div>
            </section>

            <section id="form" class="form-card">
                <h2>Crop Recommendation</h2>
                <div class="lang-row">
                    <label for="lang" class="lang-label">Language / ‡§≠‡§æ‡§∑‡§æ</label>
                    <select id="lang" name="lang" class="lang-select" form="predictForm" onchange="persistLang()">
                        <option value="en" {% if (lang or 'en') == 'en' %}selected{% endif %}>English</option>
                        <option value="hi" {% if (lang or 'en') == 'hi' %}selected{% endif %}>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    </select>
                </div>
                <form action="/predict" method="post" id="predictForm">
                    <input type="hidden" name="lang" id="langHidden" value="{{ lang or 'en' }}" />
                    <div class="grid">
                        <div class="field"><label for="Nitrogen">Nitrogen</label><input name="Nitrogen" type="number" placeholder="0-140" required /></div>
                        <div class="field"><label for="Phosporus">Phosphorus</label><input name="Phosporus" type="number" placeholder="5-145" required /></div>
                        <div class="field"><label for="Potassium">Potassium</label><input name="Potassium" type="number" placeholder="5-205" required /></div>
                        <div class="field"><label for="Temperature">Temperature (¬∞C)</label><input name="Temperature" type="number" step="any" placeholder="8-44" required /></div>
                        <div class="field"><label for="Humidity">Humidity (%)</label><input name="Humidity" type="number" step="any" placeholder="14-100" required /></div>
                        <div class="field"><label for="Ph">pH</label><input name="Ph" type="number" step="any" placeholder="3.5-9.9" required /></div>
                        <div class="field"><label for="Rainfall">Rainfall (mm)</label><input name="Rainfall" type="number" step="any" placeholder="20-300" required /></div>
                    </div>
                    <div class="inline-actions">
                        <button class="btn" type="submit">Predict Crop</button>
                        <button class="btn outline" type="button" onclick="fetchLocationAndSoilData()">Auto Fill via Location</button>
                    </div>
                    <div id="soil-data" class="status-box" aria-live="polite" style="display:none"></div>
                </form>
                {% if result %}
                    <div class="result-box">{{ result }}</div>
                    <div id="planting-window" class="planting-window" style="display:none"></div>
                    {% if explanation %}
                    <div class="explain-box">
                        <h3>Why this crop?</h3>
                        <p class="exp-summary">{{ explanation.summary }}</p>
                        {% if explanation.farmer_summary %}
                        <div class="farmer-simple">
                            <strong>Easy Explanation:</strong> {{ explanation.farmer_summary }}
                            {% if explanation.suggestions and explanation.suggestions|length > 0 %}
                            <ul class="farmer-suggestions">
                                {% for s in explanation.suggestions %}
                                <li>{{ s }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="exp-probs">
                            {% if explanation.probability is not none %}
                            <div class="primary-prob">Model confidence: {{ (explanation.probability * 100)|round(2) }}%</div>
                            {% endif %}
                            {% if explanation.top_alternatives %}
                            <div class="alt-prob">
                                Alternatives:
                                {% for alt in explanation.top_alternatives %}
                                    <span>{{ alt.crop }} ({{ (alt.prob * 100)|round(1) }}%)</span>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <table class="exp-table">
                            <thead><tr><th>Feature</th><th>Your</th><th>Mean</th><th>Std</th><th>Z</th><th>Assessment</th></tr></thead>
                            <tbody>
                            {% for f in explanation.feature_analysis %}
                                <tr class="assess-{{ f.assessment_class }}"><td>{{ f.name }}</td><td>{{ f.value }}</td><td>{{ f.mean }}</td><td>{{ f.std }}</td><td>{{ f.z }}</td><td>{{ f.assessment }}</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <p class="exp-footnote">Explanation derived from training set statistics; large deviations (Z &gt; 1.5) are highlighted.</p>
                    </div>
                    {% endif %}
                    {% if download_links %}
                    <div class="downloads">
                        <a href="{{ download_links['pdf'] }}" download>Download PDF</a>
                        <a href="{{ download_links['txt'] }}" download>Download Text</a>
                    </div>
                    {% endif %}
                {% endif %}
            </section>
        </main>
        <div class="footer" id="about">Built for sustainable farming ‚Ä¢ Improve accuracy with real sensor + weather integrations.</div>

        <script>
            function updateStatus(msg){const box=document.getElementById('soil-data');box.style.display='block';box.textContent=msg;}
            function fillFields(data){const map={Nitrogen:data.nitrogen,Phosporus:data.phosphorus,Potassium:data.potassium,Temperature:data.temperature,Humidity:data.moisture??data.humidity,Ph:data.ph,Rainfall:data.rainfall};Object.entries(map).forEach(([k,v])=>{if(v!==undefined&&v!==null){const el=document.querySelector(`[name="${k}"]`);if(el)el.value=v;}});}
            async function fetchLocationAndSoilData(){if(!navigator.geolocation){updateStatus('Geolocation not supported in this browser.');return;}updateStatus('Requesting location permission‚Ä¶');navigator.geolocation.getCurrentPosition(async pos=>{const {latitude,longitude}=pos.coords;window.__lastGeo={lat:latitude,lon:longitude};updateStatus(`Location acquired (${latitude.toFixed(3)}, ${longitude.toFixed(3)}). Fetching soil data‚Ä¶`);try{const res=await fetch(`/get_soil_data?lat=${latitude}&lon=${longitude}`);if(!res.ok)throw new Error('API response '+res.status);const data=await res.json();updateStatus('Soil/Weather data loaded. Populating fields.');fillFields(data);setTimeout(()=>{updateStatus('Autofill complete. Review values then Predict.')},1200);}catch(e){updateStatus('Failed to fetch live data: '+e.message);}},err=>{updateStatus('Location denied. Please allow access or fill manually.');});}

            async function fetchPlantingWindow(cropName){
                const container = document.getElementById('planting-window');
                if(!container) return;
                let lat, lon;
                if(window.__lastGeo){lat=window.__lastGeo.lat;lon=window.__lastGeo.lon;}
                if((lat===undefined || lon===undefined) && navigator.geolocation){
                    try {
                        const geo = await new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(p=>resolve(p),e=>reject(e),{timeout:5000}));
                        lat = geo.coords.latitude; lon = geo.coords.longitude; window.__lastGeo={lat,lon};
                    } catch(e) {
                        container.style.display='block';
                        container.innerHTML = '<div class="pw-badge pw-missing">Location needed for planting window. Use Auto Fill first.</div>';
                        return;
                    }
                }
                if(lat===undefined || lon===undefined){
                    container.style.display='block';
                    container.innerHTML = '<div class="pw-badge pw-missing">No location available.</div>';
                    return;
                }
                container.style.display='block';
                container.innerHTML='<div class="pw-badge pw-loading">Loading planting window‚Ä¶</div>';
                try {
                    const res = await fetch(`/api/planting_window?crop=${encodeURIComponent(cropName)}&lat=${lat}&lon=${lon}`);
                    if(!res.ok) throw new Error('HTTP '+res.status);
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    const a = data.assessment;
                    const statusMap = {optimal:'pw-optimal',moderate:'pw-moderate',poor:'pw-poor',unknown:'pw-unknown'};
                    const badgeClass = statusMap[a.status]||'pw-unknown';
                    const detail = `<div class="pw-badge ${badgeClass}"><strong>Planting Window:</strong> ${a.status.toUpperCase()} (${a.ideal_days} ideal / ${a.near_days} near of ${a.total_days} days)</div><div class=\"pw-msg\">${a.message}</div>`;
                    container.innerHTML = detail;
                } catch(e){
                    container.innerHTML = `<div class="pw-badge pw-error">Planting window unavailable (${e.message})</div>`;
                }
            }
            document.addEventListener('DOMContentLoaded', ()=>{
                const resultBox = document.querySelector('.result-box');
                if(resultBox){
                    const txt = resultBox.textContent||'';
                    const crop = txt.split(' is the best')[0];
                    if(crop) fetchPlantingWindow(crop.trim());
                }
            });
        </script>
    </body>
</html>
